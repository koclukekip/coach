<section class="container" style="max-width:1000px;margin:24px auto">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
    <h1 style="margin:0">Sohbet</h1>
    <div style="display:flex;gap:8px">
      <a routerLink="/student/conversations" style="padding:8px 16px;border:1px solid #36786b;border-radius:8px;color:#36786b;text-decoration:none;font-weight:600;background:#f0fdfa">ðŸ’¬ Sohbet</a>
      <a routerLink="/student/schedule" style="padding:8px 16px;border:1px solid #e5e7eb;border-radius:8px;color:#64748b;text-decoration:none;font-weight:600;background:#f8fafc">ðŸ“… Takvim</a>
    </div>
  </div>
  
  <!-- 2 BÃ¶lÃ¼m Layout -->
  <div style="display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap">
    <!-- Sol BÃ¶lÃ¼m: Mevcut KonuÅŸmalar -->
    <div style="flex:1;min-width:320px;border:1px solid #e5e7eb;border-radius:10px;padding:10px">
      <div style="font-weight:700;margin-bottom:8px">Mevcut KonuÅŸmalar</div>
      <div *ngIf="visibleConversations().length===0" style="font-size:12px;color:#64748b">HenÃ¼z konuÅŸma yok.</div>
      <div *ngFor="let c of visibleConversations()" (click)="toggle(c, $event)" style="border:1px solid #e5e7eb;border-radius:8px;padding:8px;margin:6px 0;cursor:pointer;transition:all 0.2s;hover:background:#f8fafc">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="display:flex;align-items:center;gap:8px">
              <span [style.background]="isCoachActiveNow(c) ? '#16a34a' : '#94a3b8'" style="display:inline-block;width:8px;height:8px;border-radius:50%"></span>
              <div style="font-weight:600">KoÃ§: {{ c.coachUsername }}</div>
              <span *ngIf="isCoachActiveNow(c)" style="font-size:12px;color:#16a34a">Aktif</span>
            </div>
            <div style="font-size:12px;color:#64748b;display:flex;align-items:center;gap:6px">
              <span>Durum:</span>
              <span *ngIf="c.status==='ACCEPTED'" style="color:#16a34a">âœ“ Kabul edildi</span>
              <span *ngIf="c.status==='REJECTED'" style="color:#dc2626">âœ— Reddedildi</span>
              <span *ngIf="c.status==='PENDING'" style="color:#64748b">â€¢ Beklemede</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- SaÄŸ BÃ¶lÃ¼m: Yeni Talep -->
    <div style="flex:1;min-width:320px;border:1px solid #e5e7eb;border-radius:10px;padding:10px">
      <div style="font-weight:700;margin-bottom:8px">Yeni Talep</div>
      <form (ngSubmit)="request()" class="request-form" *ngIf="!hasAccepted()">
        <div class="input-wrap">
          <span class="prefix">ðŸ‘¤</span>
          <input placeholder="KoÃ§ kullanÄ±cÄ± adÄ±" [ngModel]="coach()" (ngModelChange)="coach.set($event)" name="coach" required />
        </div>
        <button class="btn btn-primary cta" type="submit">âž• Talep GÃ¶nder</button>
      </form>
      <div *ngIf="hasAccepted()" style="font-size:12px;color:#64748b;text-align:center;padding:20px">
        Zaten bir koÃ§ ile konuÅŸma baÅŸlattÄ±nÄ±z.
      </div>
    </div>
  </div>
  
  <!-- KonuÅŸma DetaylarÄ± -->
  <ng-container *ngFor="let c of visibleConversations()">
    <div *ngIf="activeId()===c.id" style="margin-top:16px;border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fafafa">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div>
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px">
          <span [style.background]="isCoachActiveNow(c) ? '#16a34a' : '#94a3b8'" style="display:inline-block;width:8px;height:8px;border-radius:50%"></span>
          <div style="font-weight:600;font-size:16px">KoÃ§: {{ c.coachUsername }}</div>
          <span *ngIf="isCoachActiveNow(c)" style="font-size:12px;color:#16a34a;background:#dcfce7;padding:2px 6px;border-radius:4px">Aktif</span>
        </div>
        <div style="font-size:12px;color:#64748b">
          <span *ngIf="c.status==='ACCEPTED'" style="color:#16a34a">âœ“ Kabul edildi</span>
          <span *ngIf="c.status==='REJECTED'" style="color:#dc2626">âœ— Reddedildi</span>
          <span *ngIf="c.status==='PENDING'" style="color:#64748b">â€¢ Beklemede</span>
        </div>
      </div>
    </div>
    <div (click)="$event.stopPropagation()">
      <div *ngIf="nextBooked()" style="margin:8px 0;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#f0f9ff;color:#075985">
        Sonraki oturum: {{ formatRange(nextBooked()!.start, nextBooked()!.end) }}
      </div>
      <div #messagesBox style="max-height:300px;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#f8fafc;padding:10px;border-radius:10px">
        <ng-container *ngFor="let m of messages(); let i = index">
          <div *ngIf="isNewDay(i)" style="text-align:center;color:#94a3b8;font-size:12px;margin:6px 0">{{ formatDay(m.ts) }}</div>
          <div [style]="m.role==='user'? 'text-align:left' : 'text-align:right'">
            <span style="display:inline-block;padding:8px 12px;border-radius:12px;max-width:80%" [style.background]="m.role==='coach'?'#e0f2fe':'#fff'" [style.border]="'1px solid #e5e7eb'">
              {{ m.text }}
              <div style="font-size:11px;color:#94a3b8;margin-top:4px">{{ formatTime(m.ts) }}</div>
            </span>
          </div>
        </ng-container>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
        <button class="btn" type="button" (click)="toggleVideo()" *ngIf="isWithinActiveBookedWindow()" style="border:1px solid #e5e7eb;border-radius:10px;padding:10px 14px">ðŸŽ¥ Video</button>
        <a routerLink="/student/schedule" style="padding:8px 12px;border:1px solid #36786b;border-radius:10px;color:#36786b;text-decoration:none;font-weight:600;background:#f0fdfa">ðŸ“… Randevu Planla</a>
      </div>
      <div *ngIf="videoActive()" style="display:flex;gap:8px;margin-top:10px;align-items:flex-start">
        <video [appMediaStream]="localStream()" muted playsinline style="width:45%;background:#000;border-radius:8px"></video>
        <video [appMediaStream]="remoteStream()" playsinline style="width:55%;background:#000;border-radius:8px"></video>
      </div>
      <form (ngSubmit)="send()" style="display:flex;gap:8px;margin-top:10px">
        <input name="msg" [ngModel]="draft()" (ngModelChange)="draft.set($event)" placeholder="Mesaj yazÄ±n..." style="flex:1;border:1px solid #e5e7eb;border-radius:10px;padding:10px"/>
        <button class="btn btn-primary" type="submit" style="background:#36786b;color:#fff;border:none;border-radius:10px;padding:10px 14px">GÃ¶nder</button>
      </form>
      </div>
    </div>
  </ng-container>
</section>


